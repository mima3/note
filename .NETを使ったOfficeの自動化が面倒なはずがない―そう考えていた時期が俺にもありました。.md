# å‰æ›¸ã  
>.NETã‚’ä½¿ã£ãŸOfficeã®è‡ªå‹•åŒ–ãŒé¢å€’ãªã¯ãšãŒãªã„  
  
  
â€•ãã†è€ƒãˆã¦ã„ãŸæ™‚æœŸãŒä¿ºã«ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚  
  
ä»¥ä¸‹ã®PowerShellã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚  
  
```powershell
	$app = New-Object -ComObject Excel.Application
	$books = $app.Workbooks
	$book = $books.Open("test.xlsx")
	Write-Host $book.Sheets["Sheet1"].Cells[1,1].Text

	$book.Close()
	$app.Quit();
```  
  
Excelã‚’ç«‹ã¡ä¸Šã’ã¦ã€ã‚·ãƒ¼ãƒˆã®ã‚»ãƒ«ã‚’è¡¨ç¤ºã—ã€Excelã‚’çµ‚äº†ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚  
æœ¬æ¥ã§ã‚ã‚Œã°ã€ãªã‚“ã®å•é¡Œã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚  
  
**ã—ã‹ã—ãªãŒã‚‰ã€èµ·å‹•ã—ãŸExcelã®ãƒ—ãƒ­ã‚»ã‚¹ã¯çµ‚äº†ã›ãšã‚¿ã‚¹ã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«æ®‹ã‚Šç¶šã‘ã¾ã™ã€‚**  
  
ä»Šå›ã¯Excelã§èª¬æ˜ã—ã¾ã—ãŸãŒã€ã“ã‚Œã¯Wordã§ã‚‚Outlookã§ã‚‚åŒæ§˜ã§ã™ã€‚ã¾ãŸã€PowerShellã§ãªãC#ã§åŒæ§˜ã®å®Ÿè£…ã‚’ã—ã¦ã‚‚ã€ã“ã®å•é¡Œã¯ç™ºç”Ÿã—ã¾ã™ã€‚  
  
  
# ä½•ãŒå•é¡Œãªã®ã‹ï¼Ÿ  
Office ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å‰²ã‚Šå½“ã¦ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**è‡ªåˆ†**ã§è§£æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
è§£æ”¾å‡¦ç†ã‚’é©åˆ‡ã«è¡Œã‚ãªã„ã“ã¨ã§ã€äºˆæœŸã›ã¬å‹•ä½œã‚„ã€ãƒ¡ãƒ¢ãƒªã®åœ§è¿«ã‚’å¼•ãèµ·ã“ã—ã¾ã™ã€‚  
è§£æ”¾å‡¦ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ã¤ã„ã¦ã¯ãƒã‚¤ã‚¯ãƒ­ã‚½ãƒ•ãƒˆã®ä¸­ã®äººãŒä»¥ä¸‹ã®ã‚ˆã†ãªè¨˜äº‹ã‚’ã‚ã’ã¦ã„ã¾ã™ã€‚  
  
[Office ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å‰²ã‚Šå½“ã¦ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾ã™ã‚‹ â€“ Part1](https://social.msdn.microsoft.com/Forums/ja-JP/5deec897-a897-404b-a610-f7d894fde1b3/office?forum=officesupportteamja)  
[Office ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å‰²ã‚Šå½“ã¦ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾ã™ã‚‹ â€“ Part2](https://blogs.msdn.microsoft.com/office_client_development_support_blog/2012/02/28/office-3/)  
  
.NETã§Officeã®æ“ä½œã‚’ã™ã‚‹å ´åˆã¯å¿…ãšä¸€èª­ã—ã¦ãŠãã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚  
ä¸Šè¨˜ã€è¨˜äº‹ã®ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚  
  
ãƒ»ä½œæˆã•ã‚ŒãŸRCWã¯ReleaseComObjectã§è§£æ”¾ã‚’è¡Œã†  
ãƒ»Officeã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ‚äº†å‰å¾Œã«ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œã™ã‚‹  
  
  
## ä½œæˆã•ã‚ŒãŸReleaseComObjectã§è§£æ”¾å‡¦ç†ã‚’è¡Œã†ã€‚  
New æ¼”ç®—å­ã§ Excel.Application ã‚¯ãƒ©ã‚¹ç­‰ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€RCW (ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å‘¼ã³å‡ºã—å¯èƒ½ãƒ©ãƒƒãƒ‘ãƒ¼) ã‚‚ç”Ÿæˆã•ã‚Œ COM ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚  
ã“ã“ã§ä½œæˆã—ãŸRCWã¯ReleaseComObjctã‚’å®Ÿè¡Œã—ã¦å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¸›ç®—ã—ã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã‚ãªã„ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè§£æ”¾ã•ã‚Œãšã«äºˆæœŸã›ã¬å‹•ä½œã‚’å¼•ãèµ·ã“ã—ã¾ã™ã€‚  
   
```powershell
	# ã“ã“ã§RCWãŒä½œæˆã•ã‚Œã‚‹ã€‚
	$app = New-Object -ComObject Excel.Application
	$app.Quit()

	# ä½œæˆã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ReleaseComObjectã‚’ç”¨ã„ã¦è§£æ”¾ã™ã‚‹ã€‚
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($app)

```  
  
COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æš—é»™çš„ã«ä½œæˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã€ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ãŒãã‚Œã«ã‚ãŸã‚Šã¾ã™ã€‚  
  
```powershell
	# ã“ã“ã§RCWãŒä½œæˆã•ã‚Œã‚‹ã€‚
	$app = New-Object -ComObject Excel.Application

	# æš—é»™çš„ã«ã€ŒMicrosoft.Office.Interop.Excel.Workbooksã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã‚‹ã€‚
	Write-Host $app.WorkBooks.Count

	$app.Quit()

	# ä½œæˆã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ReleaseComObjectã‚’ç”¨ã„ã¦è§£æ”¾ã™ã‚‹ã€‚
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($app)

```  
  
ä¸Šè¨˜ã®æš—é»™çš„ã«ä½œæˆã•ã‚Œã‚‹COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚è§£æ”¾å‡¦ç†ã‚’è¨˜è¼‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
ã¤ã¾ã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
  
```powershell
	# ã“ã“ã§RCWãŒä½œæˆã•ã‚Œã‚‹ã€‚
	$app = New-Object -ComObject Excel.Application

	$books = $app.WorkBooks
	Write-Host $books.Count

	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($books)
	$app.Quit()

	# ä½œæˆã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ReleaseComObjectã‚’ç”¨ã„ã¦è§£æ”¾ã™ã‚‹ã€‚
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($app)

```  
  
[How to properly release Excel COM objects](https://www.add-in-express.com/creating-addins-blog/2013/11/05/release-excel-com-objects/#rule)ã§è¿°ã¹ã¦ã„ã‚‹ã‚ˆã†ã«ã€Œ1 dot good, 2 dots badã€ã¨è¦šãˆã‚‹ã¨æ¥½ã ã¨æ€ã„ã¾ã™ã€‚  
  
## Officeã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ‚äº†å‰å¾Œã«ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œã™ã‚‹  
Office é–‹ç™ºç³»ã‚µãƒãƒ¼ãƒˆã®æå”±ã™ã‚‹ã„ã‚ã‚†ã‚‹ã€Œãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€ã§ã¯Officeã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ‚äº†å‰å¾Œã«æ˜ç¤ºçš„ã«ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’è–¦ã‚ã¦ã„ã¾ã™ã€‚  
  
>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ‚äº†æ™‚ã«ã¯ã€Excel ã‹ã‚‰ã® COM ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‚ç…§è§£æ”¾å‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¾ã§ã«é©åˆ‡ã« COM ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè§£æ”¾ã•ã‚Œã¦ã„ãªã„ã¨ã€ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã£ã¦ã¯äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç”Ÿã˜ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ‚äº†å‰ã«ã¾ãšã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚  
>  
>ã•ã‚‰ã«ã€Application ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è§£æ”¾ã™ã‚‹éš›ãªã®ã§ã™ãŒã€Marshal.ReleaseComObject ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦å‚ç…§ã‚«ã‚¦ãƒ³ã‚¿ã‚’ãƒ‡ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ãŸã ã‘ã§ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã§ãã¾ã›ã‚“ã®ã§ã€GC.Collect ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’å¼·åˆ¶ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾ã—ã¦ã„ã¾ã™ã€‚  
  
  
  
ã¤ã¾ã‚Šã„ã‚ã‚†ã‚‹ã€Œãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚  
  
```powershell
	# ã“ã“ã§RCWãŒä½œæˆã•ã‚Œã‚‹ã€‚
	$app = New-Object -ComObject Excel.Application

	$books = $app.WorkBooks
	Write-Host $books.Count

	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($books)

	# GCã®å¯¾è±¡ã«ãªã‚‹ã‚ˆã†ã«NULLã‚’ã„ã‚Œã¦å¤‰æ•°ã®å‚ç…§ã‚’åˆ‡ã‚‹
	$books = $null
	Remove-Variable books -ErrorAction SilentlyContinue

	# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å‰ã®GC
	[System.GC]::Collect()
	[System.GC]::WaitForPendingFinalizers()
	[System.GC]::Collect()

	$app.Quit()

	# ä½œæˆã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ReleaseComObjectã‚’ç”¨ã„ã¦è§£æ”¾ã™ã‚‹ã€‚
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($app)

	# GCã®å¯¾è±¡ã«ãªã‚‹ã‚ˆã†ã«NULLã‚’ã„ã‚Œã¦å¤‰æ•°ã®å‚ç…§ã‚’åˆ‡ã‚‹
	$app = $null
	Remove-Variable app -ErrorAction SilentlyContinue

	# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å‰ã®GC
	[System.GC]::Collect()
	[System.GC]::WaitForPendingFinalizers()
	[System.GC]::Collect()

```  
  
ã¾ãŸã€ä»¥ä¸‹ã®ã‚ˆã†ã«ReleaseComObjectãªã—ã®ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã ã‘ã§Excelã®ãƒ—ãƒ­ã‚»ã‚¹ã¯çµ‚äº†ã—ã¦ä¸€è¦‹æ­£ã—ãå‹•ã„ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚  
  
```powershell
	# ã“ã“ã§RCWãŒä½œæˆã•ã‚Œã‚‹ã€‚
	$app = New-Object -ComObject Excel.Application

	$books = $app.WorkBooks
	Write-Host $books.Count

	# GCã®å¯¾è±¡ã«ãªã‚‹ã‚ˆã†ã«NULLã‚’ã„ã‚Œã¦å¤‰æ•°ã®å‚ç…§ã‚’åˆ‡ã‚‹
	$books = $null
	Remove-Variable books -ErrorAction SilentlyContinue

	# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å‰ã®GC
	[System.GC]::Collect()
	[System.GC]::WaitForPendingFinalizers()
	[System.GC]::Collect()

	$app.Quit()

	# GCã®å¯¾è±¡ã«ãªã‚‹ã‚ˆã†ã«NULLã‚’ã„ã‚Œã¦å¤‰æ•°ã®å‚ç…§ã‚’åˆ‡ã‚‹
	$app = $null
	Remove-Variable app -ErrorAction SilentlyContinue

	# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å‰ã®GC
	[System.GC]::Collect()
	[System.GC]::WaitForPendingFinalizers()
	[System.GC]::Collect()

```  
  
ã€Œ[Office ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å‰²ã‚Šå½“ã¦ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾ã™ã‚‹ â€“ Part2](https://blogs.msdn.microsoft.com/office_client_development_support_blog/2012/02/28/office-3/)ã€ã®Tipsã§ã¯ã“ã®å±é™ºæ€§ã‚’è¨´ãˆã¦ã„ã¾ã™ã€‚  
  
>Null ä»£å…¥ã®å¾Œã€GC.Collect ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§è‰¯ã„ã‚ˆã†ã«è¦‹ãˆã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ (ä¾‹. EXCEL.EXE ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã™ã‚‹ãªã©) ãŒã€ã“ã‚Œã¯éå¸¸ã«å±é™ºãªæ–¹æ³•ã§ã™ã€‚  
RCW ã¸ã®å‚ç…§ã‚’æ®‹ã—ã¦ã„ã‚‹ã¾ã¾ã®çŠ¶æ…‹ã§ã¯ã€COM ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆã‚„å‚ç…§ç­‰ã‚’ç¹°ã‚Šè¿”ã—ãŸéš›ã«ã€ä¾‹ãˆã°é–‹ç™ºè€…ãŒè§£æ”¾æ¸ˆã¿ã¨è€ƒãˆã¦ã„ã‚‹ COM ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦æ¥ç¶šã—ã«è¡Œããªã©ã€æ­£ã—ã„ COM ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹æ¥ç¶šãŒå®Ÿæ–½ã§ãã‚‹ä¿éšœãŒã§ããªããªã‚Šã¾ã™ã€‚  
  
ãªãŠã€ã“ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¯**ã‚ãã¾ã§Officeã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®COMè§£æ”¾å‡¦ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã‚ã£ã¦ã€å…¨ã¦ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**  
ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’æ˜ç¤ºçš„ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã€ãƒ™ã‚¹ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚  
  
## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ãã®å•é¡Œç‚¹  
å‰æ›¸ãã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¼‰ã—ã¾ã—ãŸã€‚  
  
```powershell
	$app = New-Object -ComObject Excel.Application
	$books = $app.Workbooks
	$book = $books.Open("test.xlsx")
	Write-Host $book.Sheets["Sheet1"].Cells[1,1].Text

	$book.Close()
	$app.Quit();
```  
  
ã“ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚  
  
```powershellï¼špowershellã®ä¾‹.ps1
	$app = New-Object -ComObject Excel.Application
	$books = $app.Workbooks
	$book = $books.Open("test.xlsx")
	$sheets = $book.Sheets
	$sheet = $sheets["Sheet1"]
	$cells = $sheet.Cells
	$cell = $cells[1,1]
	Write-Host $cell.Text

	$book.Close()

	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($cell) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($cells) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($sheet) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($sheets) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($book) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($books) | Out-Null

	$cell = $null
	Remove-Variable cell -ErrorAction SilentlyContinue
	$cells = $null
	Remove-Variable cells -ErrorAction SilentlyContinue
	$sheet = $null
	Remove-Variable sheet -ErrorAction SilentlyContinue
	$sheets = $null
	Remove-Variable sheets -ErrorAction SilentlyContinue
	$book = $null
	Remove-Variable book -ErrorAction SilentlyContinue
	$books = $null
	Remove-Variable books -ErrorAction SilentlyContinue

	[System.GC]::Collect()
	[System.GC]::WaitForPendingFinalizers()
	[System.GC]::Collect()

	$app.Quit();

	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($app) | Out-Null
	$app = $null
	Remove-Variable app -ErrorAction SilentlyContinue

	[System.GC]::Collect()
	[System.GC]::WaitForPendingFinalizers()
	[System.GC]::Collect()
```  
  
  
**C#ã®ä¾‹**  
```csharp:C#ã®ä¾‹
using Excel = Microsoft.Office.Interop.Excel;

//ã€€ç•¥
        static void test1()
        {
            {
                Excel.Application app = new Excel.Application();
                {
                    Excel.Workbooks books = app.Workbooks;
                    Excel.Workbook book = books.Open(@"test.xlsx");
                    Excel.Sheets sheets = book.Sheets;
                    Excel.Worksheet sheet = sheets["Sheet1"];
                    Excel.Range cells = sheet.Cells;
                    Excel.Range cell = cells[1, 1];
                    Console.WriteLine(cell.Value);
                    
                    book.Close(Type.Missing, Type.Missing, Type.Missing);

                    Marshal.ReleaseComObject(cell);
                    Marshal.ReleaseComObject(cells);
                    Marshal.ReleaseComObject(sheet);
                    Marshal.ReleaseComObject(sheets);
                    Marshal.ReleaseComObject(book);
                    Marshal.ReleaseComObject(books);

                }
                GC.Collect();
                GC.WaitForPendingFinalizers();
                GC.Collect();

                app.Quit();
                Marshal.ReleaseComObject(app);
            }

            // Application ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¬ãƒ™ãƒ¼ã‚¸ ã‚³ãƒ¬ã‚¯ãƒˆã‚’å¼·åˆ¶ã—ã¾ã™ã€‚
            GC.Collect();
            GC.WaitForPendingFinalizers();
            GC.Collect();
        }
```  
  
ã„ã‚ã‚†ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã¯ã‚³ãƒ¼ãƒ‰ã®ã‚¹ãƒ†ãƒƒãƒ—æ•°ãŒæ•°å€ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚  
  
ã¾ãŸã€ReleaseComObjectã«ã‚ˆã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾æ¼ã‚Œã‚’æ¤œçŸ¥ã™ã‚‹ã“ã¨ãŒéå¸¸ã«å„ä»‹ã§ã™ã€‚  
ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ä»®ã«ReleaseComObjectã‚’ã„ãã¤ã‹æ¼ã‚‰ã—ã¦ã‚‚ã€ãã‚Œã‚’æ¤œçŸ¥ã™ã‚‹ã“ã¨ã¯å›°é›£ã§ã™ã€‚  
å…ˆã«èª¬æ˜ã—ãŸã‚ˆã†ã«EXCELã®ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã™ã‚‹ãªã©ã®**äº‹è±¡**ã§è§£æ”¾æ¼ã‚ŒãŒèµ·ãã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œçŸ¥ã™ã‚‹ã“ã¨ã¯é›£ã—ã„ã§ã™ã€‚  
  
ã¾ãŸã€æš—é»™çš„ã«ä½œæˆã•ã‚Œã‚‹COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒãŒæ„å›³ã›ã¬ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãŠã“ãªã‚ã‚Œã¾ã™ã€‚  
ãŸã¨ãˆã°ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’10åˆ†ã»ã©èª­ã‚“ã§è¦‹ã¦è§£æ”¾æ¼ã‚Œã‚’è€ƒãˆã¦ã¿ã¦ãã ã•ã„ã€‚  
  
  
```csharp
                Excel.Application app = new Excel.Application();
                {
                    Excel.Workbooks books = app.Workbooks;
                    Excel.Workbook book = books.Open(@"test.xlsx");
                    Excel.Sheets sheets = book.Sheets;

                    foreach(Excel.Worksheet sheet in sheets)
                    {
                        Console.WriteLine(sheet.Name);
                        Marshal.ReleaseComObject(sheet);
                        Console.ReadLine();
                    }

                    Console.WriteLine("Excelèµ·å‹•æ¸ˆã¿");
                    Console.ReadLine();

                    book.Close(Type.Missing, Type.Missing, Type.Missing);

                    Marshal.ReleaseComObject(sheets);
                    Marshal.ReleaseComObject(book);
                    Marshal.ReleaseComObject(books);

                }
                GC.Collect();
                GC.WaitForPendingFinalizers();
                GC.Collect();

                app.Quit();
                Marshal.ReleaseComObject(app);
                Console.WriteLine("ReleaseComObject");
                Console.ReadLine();
            }

            // Application ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¬ãƒ™ãƒ¼ã‚¸ ã‚³ãƒ¬ã‚¯ãƒˆã‚’å¼·åˆ¶ã—ã¾ã™ã€‚
            GC.Collect();
            GC.WaitForPendingFinalizers();
            GC.Collect();
            Console.WriteLine("ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿");
            Console.ReadLine();
```  
  
å®Ÿã¯ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã®foreachå¥ã§ã€ŒSystem.Runtime.InteropServices.CustomMarshalers.EnumeratorViewOfEnumVariantã€ã‹ã‚‰COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚  
  
```csharp
                    foreach(Excel.Worksheet sheet in sheets)
                    {
                        Console.WriteLine(sheet.Name);
                        Marshal.ReleaseComObject(sheet);
                        Console.ReadLine();
                    }
```  
  
ãã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«foreachã‚’ä½¿ã‚ãšã«COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ“ä½œã—ãŸæ–¹ãŒå®‰å…¨ã§ã™ã€‚  
  
```csharp
                    for (int i = 1; i <= sheets.Count; ++i)
                    {
                        Excel.Worksheet sheet = book.Sheets[i];
                        Console.WriteLine(sheet.Name);
                        Marshal.ReleaseComObject(sheet);
                        Console.ReadLine();
                    }
```  
  
ã“ã®ã‚ˆã†ã«ã€æŒ™å‹•ã‚’ç†è§£ã—ãŸä¸Šã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¾ãªã„ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ãƒ¡ãƒ¢ãƒªè§£æ”¾ã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ããªã„ã®ã§ã™ã€‚  
  
## ã„ã‚ã‚†ã‚‹ã€Œãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€ã®å•é¡Œç‚¹ã®å¯¾å¿œç­–  
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¾ãªã„ã¨é©åˆ‡ã«ãƒ¡ãƒ¢ãƒªè§£æ”¾ã‚’ã—ã¦ã„ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã€ã‹ã¤ã€ã‚¿ã‚¹ã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã ã‘ã§ã¯ãƒ¡ãƒ¢ãƒªãŒæ­£ã—ãè§£æ”¾ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’æ¤œçŸ¥ã™ã‚‹ã®ãŒå›°é›£ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚  
ã•ã™ãŒã«ä»¤å’Œã®æ™‚ä»£ã«ãƒ¡ãƒ¢ãƒªè§£æ”¾ã‚’æ°—ã«ã—ã¦å®Ÿè£…ã™ã‚‹ã®ã¯è¾›ã„ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã€ã“ã®çŠ¶æ³ã‚’æ”¹å–„ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦æ¤œè¨ã—ã¦ã¿ã¾ã™ã€‚  
  
### NetOfficeã‚’ä½¿ç”¨ã—ã¦COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾ã‚’ä»»ã›ã‚‹  
NetOfficeã¨ã„ã†MIT Licenseã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå­˜åœ¨ã—ã¾ã™ã€‚  
https://github.com/NetOfficeFw/NetOffice  
  
Officeã®å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã—ã¦ReleaseComObjectã‚’è¡Œã‚ãªãã¦ã‚‚ã™ã‚€ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚  
  
```csharp

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Excel = NetOffice.ExcelApi;

namespace NetOfficeSample
{
    class Program
    {
        static void Main(string[] args)
        {
            using (Excel.Application app = new Excel.Application()) {
                Excel.Workbook book = app.Workbooks.Open(@"test.xlsx");
                Excel.Worksheet workSheet = (Excel.Worksheet)book.Worksheets[1];
                Console.WriteLine(workSheet.Cells[1, 1].Value);

                Console.WriteLine("èµ·å‹•æ¸ˆã¿");
                Console.ReadLine();
                book.Close();
                app.Quit();

            }
            Console.WriteLine("Applicationçµ‚äº†");
            Console.ReadLine();
        }

    }
}
```  
  
ãŸã ã—ã€NetOfficeã®ã‚³ãƒ¼ãƒ‰ã‚’ã¿ã‚‹ã‹ãã‚Šã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’æ˜ç¤ºçš„ã«ã‚„ã£ã¦ã„ãªã„ã‚ˆã†ã«ã¿ãˆã‚‹ã®ã§ã€ã„ã‚ã‚†ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã¯é•ã†éƒ¨åˆ†ãŒã‚ã‚Šã¾ã™ã€‚  
  
### RCWã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ³ã‚’ç›£è¦–ã™ã‚‹ã€‚  
RCW (ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å‘¼ã³å‡ºã—å¯èƒ½ãƒ©ãƒƒãƒ‘ãƒ¼) ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾çŠ¶æ³ã‚’ç›£è¦–ã—ãªãŒã‚‰å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚  
ãã®ãŸã‚ã«ã¯ã€ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ’ãƒ¼ãƒ—ã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€Microsoft.Diagnostics.Runtime.dll (nicknamed "CLR MD")ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚  
  
https://github.com/microsoft/clrmd  
  
**ãªãŠã€ã‚¦ã‚£ãƒ«ã‚¹ãƒã‚¹ã‚¿ãƒ¼ãªã©ã®ã‚¦ã‚£ãƒ«ã‚¹å¯¾ç­–ã‚½ãƒ•ãƒˆã¯ã€ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚¢ã‚¿ãƒƒãƒã—ã¦ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ’ãƒ¼ãƒ—ã‚’èª¿ã¹ã‚‹æ“ä½œã‚’ã€Œæ€ªã—ã„æ“ä½œã€ã¨ã¿ãªã™ã®ã§ã€é™¤å¤–ãƒªã‚¹ãƒˆã«å…¥ã‚Œã¦å¯¾å¿œã—ã¦ãã ã•ã„ã€‚**  
  
ä»¥ä¸‹ã§èª¬æ˜ã™ã‚‹COMã®è§£æ”¾æ¼ã‚Œã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ãƒã‚¤ãƒŠãƒªãŒã‚ã‚‹ã®ã§å¿…è¦ã«å¿œã˜ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚  
https://github.com/mima3/MemoryCheck  
  
  
#### RCWã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«  
ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ’ãƒ¼ãƒ—ä¸­ã®RCWã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’ä»¥ä¸‹ã«è¨˜è¼‰ã—ã¾ã™ã€‚  
  
```csharp
using Microsoft.Diagnostics.Runtime;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace EnumRcw
{
    class Program
    {
        static void Main(string[] args)
        {
            foreach (var process in System.Diagnostics.Process.GetProcessesByName(args[0]))
            {
                int pid = process.Id;
                Console.WriteLine("{0} {1} =======================================================", args[0], pid);
                using (var dataTarget = DataTarget.AttachToProcess(pid, 1000))
                {
                    Console.WriteLine(dataTarget.Architecture);
                    var clrVersion = dataTarget.ClrVersions.First();
                    var dacInfo = clrVersion.DacInfo;
                    ClrRuntime runtime = clrVersion.CreateRuntime();
                    foreach (var obj in runtime.Heap.EnumerateObjects())
                    {
                        ClrType type = obj.Type;
                        ulong size = obj.Size;
                        if (type.IsRCW(obj))
                        {
                            RcwData rcw = type.GetRCWData(obj);
                            if (rcw != null)
                            {
                                string ifname = "";
                                foreach (var i in rcw.Interfaces)
                                {
                                    ifname += i.Type.Name + ",";
                                }
                                Console.WriteLine("{0,16:X} {1,12:n0} {2} {3} {4} {5}", obj.Address, size, type.Name, rcw.RefCount, rcw.Disconnected, ifname);

                            }
                            else
                            {
                                Console.WriteLine("{0,16:X} {1,12:n0} {2} (GetRCWDataã«å¤±æ•—)", obj.Address, size, type.Name);

                            }
                        }
                    }
                }
            }
        }
    }
}


```  
  
ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯æŒ‡å®šã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚¢ã‚¿ãƒƒãƒã—ã¦ã€ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ’ãƒ¼ãƒ—ä¸­ã®RCWã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™ã—ã¾ã™ã€‚  
ã“ã®éš›ã€ã‚¢ã‚¿ãƒƒãƒå¯¾è±¡ã®ãƒ—ãƒ­ã‚»ã‚¹ã¨åŒã˜ã«ãªã‚‹ã‚ˆã†ã«ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’X86/X64ã‚’æ˜ç¤ºã—ã¦ãã ã•ã„ã€‚  
  
![image.png](/image/427003e8-0895-3cfd-e75d-6aa9d835e439.png)  
  
  
ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ãƒ—ãƒ­ã‚»ã‚¹åğŸ…‚ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ç¾åœ¨ã®ãƒ’ãƒ¼ãƒ—ä¸­ã®RCWã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™ã—ã¾ã™ã€‚  
ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã¯ã€Œforeach(Excel.Worksheet sheet in sheets)ã€ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã«ãŠã‘ã‚‹RCWã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™ã—ãŸä¾‹ã«ãªã‚Šã¾ã™ã€‚  
  
  
```
>EnumRcw ãƒ—ãƒ­ã‚»ã‚¹å
memorycheck 18688 =======================================================
Amd64
     25601C57CE8           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
     25601C57D08           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     25601C58348           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel._Workbook,
     25601C58368           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Sheets,
     25601C58C78           32 System.__ComObject 1 False
     25601C58DA8           32 System.__ComObject (GetRCWDataã«å¤±æ•—)
```  
  
#### æŒ‡å®šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™  
Microsoft.Diagnostics.Runtime.dll ã§ã¯æŒ‡å®šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒGCã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã€ã©ã®ãƒ‘ã‚¹ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚  
https://blog.maartenballiauw.be/post/2017/01/03/exploring-.net-managed-heap-with-clrmd.html  
  
```csharp
using Microsoft.Diagnostics.Runtime;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace WalkHeap
{
    class Program
    {
        static void Main(string[] args)
        {
            string name = args[0];
            foreach (var process in System.Diagnostics.Process.GetProcessesByName(args[0]))
            {
                int pid = process.Id;
                Console.WriteLine("{0} {1} =======================================================", args[0], pid);
                ulong taregetPtr = ulong.Parse(args[1], System.Globalization.NumberStyles.HexNumber);

                using (var dataTarget = DataTarget.AttachToProcess(pid, 1000))
                {
                    var clrVersion = dataTarget.ClrVersions.First();
                    var dacInfo = clrVersion.DacInfo;
                    ClrRuntime runtime = clrVersion.CreateRuntime();
                    var stack = new Stack<ulong>();

                    var heap = runtime.Heap;
                    if (heap.CanWalkHeap)
                    {
                        Console.WriteLine("-----");
                        foreach (var ptr in heap.EnumerateObjectAddresses())
                        {
                            var type = heap.GetObjectType(ptr);
                            if (type == null || taregetPtr != ptr)
                            {
                                continue;
                            }

                            Console.WriteLine("find");

                            // todo: retention path
                            Console.WriteLine("roots...");
                            foreach (var root in heap.EnumerateRoots())
                            {
                                stack.Clear();
                                stack.Push(root.Object);

                                if (GetPathToObject(heap, ptr, stack, new HashSet<ulong>()))
                                {
                                    // Print retention path
                                    var depth = 0;
                                    foreach (var address in stack)
                                    {
                                        var t = heap.GetObjectType(address);
                                        if (t == null)
                                        {
                                            Console.WriteLine("{0} {1,16:X} ", new string('+', depth++), address);
                                            continue;
                                        }

                                        Console.WriteLine("{0} {1,16:X} - {2} - {3} bytes", new string('+', depth++), address, t.Name, t.GetSize(address));
                                    }

                                    break;
                                }
                            }

                            break;
                        }
                    }

                }

            }
        }

        // https://blog.maartenballiauw.be/post/2017/01/03/exploring-.net-managed-heap-with-clrmd.html
        private static bool GetPathToObject(ClrHeap heap, ulong objectPointer, Stack<ulong> stack, HashSet<ulong> touchedObjects)
        {
            // Start of the journey - get address of the first objetc on our reference chain
            var currentObject = stack.Peek();

            // Have we checked this object before?
            if (!touchedObjects.Add(currentObject))
            {
                return false;
            }

            // Did we find our object? Then we have the path!
            if (currentObject == objectPointer)
            {
                return true;
            }


            // Enumerate internal references of the object
            var found = false;
            var type = heap.GetObjectType(currentObject);
            if (type != null)
            {
                type.EnumerateRefsOfObject(currentObject, (innerObject, fieldOffset) =>
                {
                    if (innerObject == 0 || touchedObjects.Contains(innerObject))
                    {
                        return;
                    }

                    // Push the object onto our stack
                    stack.Push(innerObject);
                    if (GetPathToObject(heap, objectPointer, stack, touchedObjects))
                    {
                        found = true;
                        return;
                    }

                    // If not found, pop the object from our stack as this is not the tree we're looking for
                    stack.Pop();
                });
            }

            return found;
        }
    }
}

```  
  
ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ—ãƒ­ã‚»ã‚¹åã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€æŒ‡å®šã®ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã€ã©ã®ã‚ˆã†ã«å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã‹è¡¨ç¤ºã—ã¾ã™ã€‚  
  
```
>WalkHeap.exe memorycheck 25601C58C78
memorycheck 18688 =======================================================
-----
find
roots...
      25601C58C78 - System.__ComObject - 32 bytes
+      25601C58CD0 - System.Runtime.InteropServices.CustomMarshalers.EnumeratorViewOfEnumVariant - 40 bytes

```  
  
#### RCWã®è§£æ”¾çŠ¶æ³ã®æ¤œè¨¼  
ãƒ’ãƒ¼ãƒ—ä¸Šã®RCWã®çŠ¶æ³ã‚’æ¤œæŸ»ã™ã‚‹æ–¹æ³•ãŒåˆ†ã‹ã£ãŸã®ã§æ§˜ã€…ãªã‚±ãƒ¼ã‚¹ã§å®Ÿé¨“ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚  
  
**OS**  
ã€€Windows10 64bit  
  
**Excel**  
ã€€Office16ã€€Excel32bit  
  
**PowerSehll**  
ã€€5.1.17134.858(64bit)  
  
**æ“ä½œå´ã®ã‚¢ãƒ—ãƒª:**  
ã€€.NET Framework4.5.2  
 ã€€64bit  
ã€€**Releaseãƒ“ãƒ«ãƒ‰**  
 [debugãƒ“ãƒ«ãƒ‰ã ã¨æŒ™å‹•ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚](https://github.com/mima3/note/blob/master/.NETã«ãŠã‘ã‚‹ãƒãƒãƒ¼ã‚¸ãƒ’ãƒ¼ãƒ—ã¨ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³.md#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%86%85%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E7%94%9F%E5%AD%98%E6%9C%9F%E9%96%93%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)  
  
  
  
##### å®Ÿé¨“ï¼‘ã€€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è§£æ”¾æ¼ã‚ŒãŒã‚ã‚‹ã‚±ãƒ¼ã‚¹  
  
```csharp
        //using Excel = Microsoft.Office.Interop.Excel;
        static void t1()
        {
            Excel.Application app = new Excel.Application();
            app.Quit();
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†");
            Console.ReadLine();
        }
```  
  
çµæœï¼š  
  
```
memorycheck 20140 =======================================================
Amd64
     19880007BE0           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
```  
  
Microsoft.Office.Interop.Excel.ApplicationClassãŒè§£æ”¾ã•ã‚Œãšã«æ®‹ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚  
  
##### å®Ÿé¨“ï¼’ã€€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è§£æ”¾ã‚’ReleaseComObjectã§è¡Œã£ãŸå ´åˆ  
  
```csharp
        //using Excel = Microsoft.Office.Interop.Excel;
        static void t1_2()
        {
            Excel.Application app = new Excel.Application();
            app.Quit();
            Marshal.ReleaseComObject(app);
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†");
            Console.ReadLine();
        }


```  
  
çµæœï¼š  
  
```
memorycheck 16108 =======================================================
-----
```  
  
Microsoft.Office.Interop.Excel.ApplicationClassãŒè§£æ”¾ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚  
  
  
##### å®Ÿé¨“ï¼“ã€€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è§£æ”¾ã‚’ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã ã‘ã§è¡Œã£ãŸå ´åˆ  
  
```csharp
        //using Excel = Microsoft.Office.Interop.Excel;
        static void t1_3()
        {
            Excel.Application app = new Excel.Application();
            app.Quit();
            app = null;
            GC.Collect();
            GC.WaitForPendingFinalizers();
            GC.Collect();
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã† t1_3");
            Console.ReadLine();
        }
```  
  
çµæœ:  
  
```
memorycheck 8664 =======================================================
Amd64
```  
  
Microsoft.Office.Interop.Excel.ApplicationClassãŒè§£æ”¾ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚  
ãªãŠã€ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚  
  
```
memorycheck 19908 =======================================================
Amd64
     1B583A77BD8           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
```  
  
ã“ã‚Œã¯[ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œã®å ´åˆã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ãŒç•°ãªã‚‹ãŸã‚ã§ã™ã€‚](https://github.com/mima3/note/blob/master/.NETã«ãŠã‘ã‚‹ãƒãƒãƒ¼ã‚¸ãƒ’ãƒ¼ãƒ—ã¨ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³.md#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%86%85%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E7%94%9F%E5%AD%98%E6%9C%9F%E9%96%93%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)  
  
  
##### å®Ÿé¨“ï¼”ã€€æš—é»™ã®å‚ç…§ãŒä½œæˆã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹  
  
```csharp
        //using Excel = Microsoft.Office.Interop.Excel;
        static void t2()
        {
            Excel.Application app = new Excel.Application();
            // Workbooksã®æš—é»™ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
            Excel.Workbook book = app.Workbooks.Open(@"test.xlsx");
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†1");
            Console.ReadLine();
            book.Close();
            Marshal.ReleaseComObject(book);

            app.Quit();
            Marshal.ReleaseComObject(app);
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†2");
            Console.ReadLine();
        }
```  
  
çµæœï¼š  
  
```
1å›ç›®ã®ãƒ¡ãƒ¢ãƒªã®å†…å®¹
memorycheck 21916 =======================================================
Amd64
     1D04E377CE8           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
     1D04E377D08           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     1D04E378348           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel._Workbook,


2å›ç›®ã®ãƒ¡ãƒ¢ãƒªã®å†…å®¹
memorycheck 21916 =======================================================
Amd64
     1D04E377D08           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     1D04E378348           32 System.__ComObject (GetRCWDataã«å¤±æ•—)
```  
  
Microsoft.Office.Interop.Excel.Workbooksã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæš—é»™çš„ã«ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚  
ã“ã®æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾ã—ãªã„å ´åˆã€ã€ŒMicrosoft.Office.Interop.Excel._Workbookã€ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¸­é€”åŠç«¯ã«æ®‹ã£ã¦ã„ã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã¾ã™ã€‚  
  
##### å®Ÿé¨“ï¼•ã€€æš—é»™ã®å‚ç…§ãŒä½œæˆã—ãªã„ã‚ˆã†ã«ä¿®æ­£ã—ãŸã‚±ãƒ¼ã‚¹  
  
```csharp
        static void t2_1()
        {
            Excel.Application app = new Excel.Application();
            Excel.Workbooks books = app.Workbooks;
            Excel.Workbook book = books.Open(@"test.xlsx");
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†1 t_1");
            Console.ReadLine();
            book.Close();
            Marshal.ReleaseComObject(book);
            Marshal.ReleaseComObject(books);

            app.Quit();
            Marshal.ReleaseComObject(app);
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†2");
            Console.ReadLine();
        }
```  
  
çµæœï¼š  
  
```
1å›ç›®ã®ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ï¼š
memorycheck 22292 =======================================================
Amd64
     12E47377CF0           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
     12E47377D10           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     12E47378350           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel._Workbook,


2å›ç›®ã®ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ï¼š
memorycheck 22292 =======================================================
Amd64
```  
  
ä½œæˆã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå…¨ã¦å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚  
  
##### å®Ÿé¨“ï¼–ã€€for eachã‚’ç”¨ã„ãŸç¹°ã‚Šè¿”ã—ã®å ´åˆ  
  
```csharp
        static void t3()
        {
            Excel.Application app = new Excel.Application();
            Excel.Workbooks books = app.Workbooks;
            Excel.Workbook book = books.Open(@"test.xlsx");
            foreach (var sheet in book.Sheets)
            {
                Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†1(ãƒ«ãƒ¼ãƒ—å†…) t3");
                Console.ReadLine();
                Marshal.ReleaseComObject(sheet);
            }
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†2 ãƒ«ãƒ¼ãƒ—å®Œäº† t3");
            Console.ReadLine();
            book.Close();
            Marshal.ReleaseComObject(book);
            Marshal.ReleaseComObject(books);

            app.Quit();
            Marshal.ReleaseComObject(app);
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†3");
            Console.ReadLine();
        }
```  
  
çµæœï¼š  
  
```
1:ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹
memorycheck 17784 =======================================================
Amd64
     1C74A3B7D50           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
     1C74A3B7D70           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     1C74A3B83B0           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel._Workbook,
     1C74A3B83D0           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Sheets,
     1C74A3B8CE0           32 System.__ComObject 1 False
     1C74A3B8E10           32 System.__ComObject 1 False

2: 1C74A3B8CE0ã®å‚ç…§ç®‡æ‰€ã‚’èª¿ã¹ã‚‹
-----
find
roots...
      1C74A3B8CE0 - System.__ComObject - 32 bytes
+      1C74A3B8D38 - System.Runtime.InteropServices.CustomMarshalers.EnumeratorViewOfEnumVariant - 40 bytes

3: 1C74A3B8E10 ã®å‚ç…§ç®‡æ‰€ã‚’èª¿ã¹ã‚‹
-----
find
roots...
      1C74A3B8E10 - System.__ComObject - 32 bytes

4ï¼š ãƒ«ãƒ¼ãƒ—å¤–ã§ã®ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹
memorycheck 17784 =======================================================
Amd64
     1C74A3B7D50           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
     1C74A3B7D70           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     1C74A3B83B0           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel._Workbook,
     1C74A3B83D0           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Sheets,
     1C74A3B8CE0           32 System.__ComObject 1 False
     1C74A3B8E10           32 System.__ComObject (GetRCWDataã«å¤±æ•—)

5: 1C74A3B8CE0ã®å‚ç…§ç®‡æ‰€ã‚’èª¿ã¹ã‚‹
-----
find
roots...

6: 1C74A3B8E10ã®å‚ç…§ç®‡æ‰€ã‚’èª¿ã¹ã‚‹
-----
find
roots...

7: Officeã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œ
memorycheck 17784 =======================================================
Amd64

```  
  
foreachã§ãƒ«ãƒ¼ãƒ—ã‚’è¡Œã£ãŸå ´åˆã€1C74A3B8CE0ãŒæš—é»™çš„ã«ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯System.Runtime.InteropServices.CustomMarshalers.EnumeratorViewOfEnumVariantã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹ã¨ã€ã©ã“ã‹ã‚‰ã‚‚å‚ç…§ã•ã‚Œãšã‚´ãƒŸã¨ã—ã¦æ®‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚  
â€»Officeã®çµ‚äº†ã§å‰Šé™¤ã•ã‚Œã‚‹ãŒã€ãã®é–“ã€äºˆæœŸã›ã¬ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ®‹ã‚Šç¶šã‘ã‚‹  
  
  
##### å®Ÿé¨“ï¼—ã€€for eachã‚’æ’é™¤ã—ãŸç¹°ã‚Šè¿”ã—ã®å ´åˆ  
  
```csharp
        static void t3_1()
        {
            Excel.Application app = new Excel.Application();
            Excel.Workbooks books = app.Workbooks;
            Excel.Workbook book = books.Open(@"test.xlsx");
            Excel.Sheets sheets = book.Sheets;

            for (int i = 1; i <= sheets.Count; ++i)
            {
                var sheet = sheets[i];
                Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†1(ãƒ«ãƒ¼ãƒ—å†…) t3-1");
                Console.ReadLine();
                Marshal.ReleaseComObject(sheet);

            }
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†2 ãƒ«ãƒ¼ãƒ—å®Œäº† t3");
            Console.ReadLine();
            book.Close();

            Marshal.ReleaseComObject(sheets);
            Marshal.ReleaseComObject(book);
            Marshal.ReleaseComObject(books);

            app.Quit();
            Marshal.ReleaseComObject(app);
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†3");
            Console.ReadLine();
        }
```  
  
```
ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ï¼š
memorycheck 17612 =======================================================
Amd64
     29107A77D90           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
     29107A77DB0           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     29107A783F0           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel._Workbook,
     29107A78410           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Sheets,
     29107A78480           32 System.__ComObject 1 False

ãƒ«ãƒ¼ãƒ—å¤–ã®ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ï¼š
memorycheck 17612 =======================================================
Amd64
     29107A77D90           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
     29107A77DB0           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     29107A783F0           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel._Workbook,
     29107A78410           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Sheets,
     29107A78480           32 System.__ComObject (GetRCWDataã«å¤±æ•—)

Officeã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã®ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹
memorycheck 17612 =======================================================
-----

```  
  
foreachã§æš—é»™çš„ã«ä½œæˆã•ã‚ŒãŸSystem.Runtime.InteropServices.CustomMarshalers.EnumeratorViewOfEnumVariantã‹ã‚‰ã®å‚ç…§ã•ã‚Œã¦ã„ã‚‹System.__ComObjectãŒå­˜åœ¨ã—ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚  
  
##### å®Ÿé¨“ï¼˜ã€€RCWã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ¥ã®å¤‰æ•°ã«æ ¼ç´ã—ãŸå ´åˆ  
  
```csharp
        //using Excel = Microsoft.Office.Interop.Excel;
        static void t4()
        {
            Excel.Application app = new Excel.Application();
            Excel.Workbooks books = app.Workbooks;
            Excel.Workbook book = books.Open(@"test.xlsx");
            var book2 = book;
            Console.WriteLine(book.Name);
            Console.WriteLine(book2.Name);

            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†1 t_1");
            Console.ReadLine();
            book.Close();
            Marshal.ReleaseComObject(book);
            Marshal.ReleaseComObject(books);

            app.Quit();
            Marshal.ReleaseComObject(app);
            Console.WriteLine("ã“ã“ã§ãƒ’ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†2");
            Console.ReadLine();
        }
```  
  
çµæœï¼š  
  
```
1å›ç›®ï¼š
MemoryCheck 15648 =======================================================
Amd64
     1FC94A97CF0           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False Microsoft.Office.Interop.Excel._Application,
     1FC94A97D10           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,Microsoft.Office.Interop.Excel.Workbooks,
     1FC94A98350           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel._Workbook,


2å›ç›®ï¼š
MemoryCheck 15648 =======================================================
Amd64

```  
  
1å›ç›®ã®ãƒ¡ãƒ¢ãƒªã®å†…å®¹ç¢ºèªã§Excel.Workbookã‚’bookã¨book2å¤‰æ•°ã«æ ¼ç´ã—ã¦ã„ã¾ã™ãŒã€RCWã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ãŒå¢—åŠ ã—ã¦ãŠã‚‰ãšã€ã‹ã¤ã€å‚ç…§ã‚«ã‚¦ãƒ³ã‚¿ãŒï¼‘ã®ã¾ã¾ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚  
2å›ç›®ã®bookå¤‰æ•°ã®ã¿ã«ãŸã„ã—ã¦ReleaseComObjectã‚’è¡Œã†ã“ã¨ã§RCWã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã¾ã™ã€‚  
  
  
##### å®Ÿé¨“ï¼™ï¼šPowerShellã§å®Ÿè¡Œã—ãŸå ´åˆ  
  
**test2.ps1**  
```powershell:test2.ps1
	Read-Host "åˆæœŸçŠ¶æ…‹"

	$app = New-Object -ComObject Excel.Application
	$books = $app.Workbooks
	$book = $books.Open("test.xlsx")
	$sheets = $book.Sheets
	$sheet = $sheets["Sheet1"]
	$cells = $sheet.Cells
	$cell = $cells[1,1]
	Write-Host $cell.Text
	#Write-Host $cell.Value # Variant Value (Variant)ãŒè¡¨ç¤ºã•ã‚Œã‚‹
	#$cell.Value = "TEST"
	#Write-Host $cell.Text

	$book.Close()
	Read-Host "â‘ èµ·å‹•æ¸ˆã¿"

	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($cell) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($cells) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($sheet) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($sheets) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($book) | Out-Null
	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($books) | Out-Null
	Read-Host "â‘¡ReleaseComObject"

	$cell = $null
	Remove-Variable cell -ErrorAction SilentlyContinue
	$cells = $null
	Remove-Variable cells -ErrorAction SilentlyContinue
	$sheet = $null
	Remove-Variable sheet -ErrorAction SilentlyContinue
	$sheets = $null
	Remove-Variable sheets -ErrorAction SilentlyContinue
	$book = $null
	Remove-Variable book -ErrorAction SilentlyContinue
	$books = $null
	Remove-Variable books -ErrorAction SilentlyContinue


	[System.GC]::Collect()
	[System.GC]::WaitForPendingFinalizers()
	[System.GC]::Collect()

	$app.Quit();


	[System.Runtime.Interopservices.Marshal]::ReleaseComObject($app) | Out-Null
	$app = $null
	Remove-Variable app -ErrorAction SilentlyContinue

	[System.GC]::Collect()
	[System.GC]::WaitForPendingFinalizers()
	[System.GC]::Collect()
	Read-Host "ã™ã¹ã¦çµ‚äº†"
```  
  
  
çµæœï¼š  
  
```
1: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå‰
powershell 1656 =======================================================
Amd64
     2873E065E98           32 System.__ComObject 1 False Windows.Foundation.Diagnostics.IAsyncCausalityTracerStatics,

2: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã—ã¦ã€ŒåˆæœŸçŠ¶æ…‹ã€ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ç‚¹ã®çŠ¶æ…‹
powershell 1656 =======================================================
Amd64
     2873E065E98           32 System.__ComObject 1 False Windows.Foundation.Diagnostics.IAsyncCausalityTracerStatics,
     2873E709130           32 System.__ComObject (GetRCWDataã«å¤±æ•—)

â€»2873E709130ã¯ãƒ«ãƒ¼ãƒˆã‹ã‚‰æ¤œç´¢ã§ããªã„

3:ã€Œâ‘ èµ·å‹•æ¸ˆã¿:ã€ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ç‚¹ã®çŠ¶æ…‹
powershell 1656 =======================================================
Amd64
     2873E065E98           32 System.__ComObject 1 False Windows.Foundation.Diagnostics.IAsyncCausalityTracerStatics,
     2873E7B2618           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False System.Management.Automation.IDispatch,Microsoft.Office.Interop.Excel._Application,
     2873E7BA850           32 System.__ComObject 1 False System.Runtime.InteropServices.ComTypes.ITypeInfo,
     2873E87F860           32 System.__ComObject 1 False Microsoft.Office.Interop.Excel.Workbooks,System.Management.Automation.ComInterop.IDispatch,
     2873E891FE0           32 System.__ComObject 1 False System.Runtime.InteropServices.ComTypes.ITypeInfo,
     2873E8DD090           32 System.__ComObject 1 False System.Management.Automation.ComInterop.IDispatch,
     2873E8EF398           32 System.__ComObject 1 False System.Runtime.InteropServices.ComTypes.ITypeInfo,
     2873E93BB10           32 System.__ComObject 1 False System.Management.Automation.ComInterop.IDispatch,
     2873E94AE08           32 System.__ComObject 1 False System.Runtime.InteropServices.ComTypes.ITypeInfo,
     2873E9A66A0           32 System.__ComObject 1 False System.Management.Automation.ComInterop.IDispatch,
     2873E9B7928           32 System.__ComObject 1 False System.Runtime.InteropServices.ComTypes.ITypeInfo,
     2873E9F5C90           32 System.__ComObject 1 False System.Management.Automation.ComInterop.IDispatch,
     2873EA05D48           32 System.__ComObject 2 False System.Runtime.InteropServices.ComTypes.ITypeInfo,
     2873EA6ED78           32 System.__ComObject 1 False System.Management.Automation.ComInterop.IDispatch,

â€»2873E709130ã¯æ¶ˆãˆã¦ã„ã‚‹

4:ã€Œâ‘¡ReleaseComObject:ã€ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ç‚¹ã®çŠ¶æ…‹
powershell 1656 =======================================================
Amd64
     2873E065E98           32 System.__ComObject 1 False Windows.Foundation.Diagnostics.IAsyncCausalityTracerStatics,
     2873E6B77C0           32 System.__ComObject (GetRCWDataã«å¤±æ•—)
     2873E6C5288           32 System.__ComObject (GetRCWDataã«å¤±æ•—)
     2873E6DBB58           32 System.__ComObject (GetRCWDataã«å¤±æ•—)
     2873E6E0058           32 System.__ComObject (GetRCWDataã«å¤±æ•—)
     2873E6F11D8           32 System.__ComObject (GetRCWDataã«å¤±æ•—)
     2873E715028           32 System.__ComObject (GetRCWDataã«å¤±æ•—)
     2873E7B2618           32 Microsoft.Office.Interop.Excel.ApplicationClass 1 False System.Management.Automation.IDispatch,Microsoft.Office.Interop.Excel._Application,
     2873E7BA850           32 System.__ComObject 1 False System.Runtime.InteropServices.ComTypes.ITypeInfo,

5:ã€Œã™ã¹ã¦çµ‚äº†ã€ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ç‚¹ã®çŠ¶æ…‹
powershell 1656 =======================================================
Amd64
     2873E065E98           32 System.__ComObject 1 False Windows.Foundation.Diagnostics.IAsyncCausalityTracerStatics,
     2873E7BA850           32 System.__ComObject 1 False System.Runtime.InteropServices.ComTypes.ITypeInfo,


2873E7BA850ã®æ¤œç´¢çµæœã¯ä»¥ä¸‹ã®é€šã‚Š
      2873E7BA850 - System.__ComObject - 32 bytes
+      2873E7BAEA8 - System.Management.Automation.ComProperty - 64 bytes
++      2873E7E1738 - System.Collections.Generic.Dictionary+Entry<System.String,System.Management.Automation.ComProperty>[] - 10368 bytes
+++      2873E7BA950 - System.Collections.Generic.Dictionary<System.String,System.Management.Automation.ComProperty> - 80 bytes
++++      2873E7BA918 - System.Management.Automation.ComTypeInfo - 56 bytes
+++++      2873E7EC398 - System.Management.Automation.DotNetAdapterWithComTypeName - 32 bytes
++++++      2873E7EC3B8 - System.Management.Automation.PSObject+AdapterSet - 32 bytes
+++++++      2873E7EC3D8 - System.Collections.Concurrent.ConcurrentDictionary+Node<System.Type,System.Management.Automation.PSObject+AdapterSet> - 48 bytes
++++++++      2873E3FD9B8 - System.Collections.Concurrent.ConcurrentDictionary+Node<System.Type,System.Management.Automation.PSObject+AdapterSet>[] - 272 bytes
+++++++++      2873E3FDAC8 - System.Collections.Concurrent.ConcurrentDictionary+Tables<System.Type,System.Management.Automation.PSObject+AdapterSet> - 48 bytes
++++++++++      2873E3FD8B8 - System.Collections.Concurrent.ConcurrentDictionary<System.Type,System.Management.Automation.PSObject+AdapterSet> - 64 bytes
```  
  
  
PowerShellã§ã¯åˆæœŸçŠ¶æ…‹ã§ã€ŒWindows.Foundation.Diagnostics.IAsyncCausalityTracerStaticsã€ã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚  
ã„ã‚ã‚†ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å®ˆã£ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚‚ã€æ“ä½œçµ‚äº†å¾Œã«ã€ŒSystem.Runtime.InteropServices.ComTypes.ITypeInfoã€ãŒæ®‹ã‚Šã¾ã™ã€‚ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯System.Collections.Concurrent.ConcurrentDictionary<System.Type,System.Management.Automation.PSObject+AdapterSet>ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã¾ã™ã€‚  
  
â€»ä»¥ä¸‹ã®s_adapterMappingã®ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒè©³ç´°ã¯ä¸æ˜ã€‚  
https://github.com/PowerShell/PowerShell/blob/c684902fba5b5e63fa750e66270a25b6889b4ec6/src/System.Management.Automation/engine/MshObject.cs  
  
# ã¾ã¨ã‚ã¨æ„è­˜ã®ä½ã„å¯¾å¿œç­–  
.NETã§Officeã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ã„ã‚ã‚†ã‚‹ãƒ™ã‚¹ãƒˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚  
  
ãƒ»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½œæˆã—ãŸRCWã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ReleaseComObjectã§è§£æ”¾ã—ã¾ã™  
ãƒ»RCWã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æš—é»™çš„ã«ä½œæˆã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚  
ã€€ä¾‹ï¼š  
ã€€ã€€foreachå¥  
ã€€ã€€ã€Œapp.WorkBooks.Countã€ã§2ãƒ‰ãƒƒãƒˆå«ã‚€å ´åˆ  
ãƒ»Officeã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®è§£æ”¾ã ã‘ã‚’è€ƒãˆãŸå ´åˆã€Officeã®çµ‚äº†å‰å¾Œã§ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã€‚  
  
æ­£ç›´é¢å€’â€¦ã•ã‚‰ã«ã„ã†ã¨ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã®ã¯ã€ã‚ˆããªã„ã§ã™ã€‚  
  
ã“ã“ã§ã¯ã€æ„è­˜ã‚’ä½ãã—ã¦å¯¾å¿œç­–ã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚  
  
  
ã€Œ[Office ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å‰²ã‚Šå½“ã¦ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾ã™ã‚‹ â€“ Part1](https://social.msdn.microsoft.com/Forums/ja-JP/5deec897-a897-404b-a610-f7d894fde1b3/office?forum=officesupportteamja)ã€ã«ã‚ˆã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªè¨˜è¿°ãŒã‚ã‚Šã¾ã™ã€‚  
  
>ãªãŠã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ« ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç­‰ã§ã¯ã€å‡¦ç†ãŒä¸€é€šã‚Šå®Ÿè¡Œã•ã‚ŒãŸå¾Œã€ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã™ã‚‹éš›ã« CLR ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒçµ‚äº†ã™ã‚‹ã®ã«åˆã‚ã›ã¦ã€Application ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾ãŠã‚ˆã³ EXCEL.EXE ãƒ—ãƒ­ã‚»ã‚¹ã®çµ‚äº†ãŒå®Ÿæ–½ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€è§£æ”¾æ¼ã‚ŒãŒã‚ã£ãŸã¨ã—ã¦ã‚‚ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ çµ‚äº†æ™‚ã«è§£æ”¾ã•ã‚Œã‚‹ãŸã‚ã€ã»ã¨ã‚“ã©ã®å ´åˆå¤§ããªå½±éŸ¿ãŒãªã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚  
  
ã™ãªã‚ã¡ã€ Officeã®æ“ä½œã‚’ã—ã¦ã€ã™ããƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã™ã‚‹ã¨å½±éŸ¿ãŒå°‘ãªãã§ãã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚  
ãªã®ã§ã€åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§èµ·å‹•ã—ã¦å˜ä¸€ã®Officeã®æ“ä½œã‚’è¡Œã„ã€ã™ãçµ‚äº†ã™ã‚‹ã¨ã„ã†è¨­è¨ˆã«ã™ã‚‹ã“ã¨ã§ã€Officeã®è§£æ”¾æ¼ã‚Œã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚  
  
ãŸã¨ãˆã°PowerShellã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã‚‚ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œã—ã¦ã—ã¾ã„ã¾ã™ã€‚  
  
```powershell
# PowerShellã®ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è½ã¨ã™ã¾ã§å½±éŸ¿ãŒã®ã“ã‚‹
./test1.ps1

# åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§å½±éŸ¿ã‚’æŠ‘ãˆã‚‹
powershell ./test1.ps1
```  
  
ã‚ã¨ã¯ã‚ã‚Šãã£ã¦ã€å®Œç’§ãªãƒªã‚½ãƒ¼ã‚¹è§£æ”¾ã¯ã‚ãã‚‰ã‚ã¦ã€æ“ä½œä¸­ã¯Officeã‚’ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã¨ã‹é‹ç”¨ã§ã‚«ãƒãƒ¼ã—ãŸã‚Šã€äºˆæœŸã›ã¬Officeã®ãƒ—ãƒ­ã‚»ã‚¹ãŒèµ·å‹•ã—ã¦ãŸã‚‰çµ‚äº†ã•ã›ã‚‹ãªã©ã®æ„è­˜ã®ä½ã„å¯¾å‡¦æ¡ˆãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚  
  
# å‚è€ƒ  
 - [Office ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å‰²ã‚Šå½“ã¦ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾ã™ã‚‹ â€“ Part1](https://social.msdn.microsoft.com/Forums/ja-JP/5deec897-a897-404b-a610-f7d894fde1b3/office?forum=officesupportteamja)  
 - [Office ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å‰²ã‚Šå½“ã¦ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾ã™ã‚‹ â€“ Part2](https://blogs.msdn.microsoft.com/office_client_development_support_blog/2012/02/28/office-3/)  
 - [RCW & reference counting when using COM interop in C#](https://stackoverflow.com/questions/4591681/rcw-reference-counting-when-using-com-interop-in-c-sharp)  
 - [How to properly release Excel COM objects](https://www.add-in-express.com/creating-addins-blog/2013/11/05/release-excel-com-objects/)  
 - [netoffice](https://github.com/NetOfficeFw/NetOffice)  
 - [Microsoft.Diagnostics.Runtime](https://github.com/microsoft/clrmd)  
 - [Exploring .NET managed heap with ClrMD](https://blog.maartenballiauw.be/post/2017/01/03/exploring-.net-managed-heap-with-clrmd.html)  
